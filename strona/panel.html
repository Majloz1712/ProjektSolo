<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aplikacja Sondowa ‚Äì Panel</title>
  <link rel="stylesheet" href="/styl/styles.css" />

  <!-- Minimalne style layoutu (nie gryzƒÖ siƒô z Twoim styles.css) -->
  
</head>
<body class="app">
  <header class="app-header">
    <div class="app-brand">
      <button class="app-hamburger" id="btnHamburger" aria-label="Menu">&#9776;</button>
      <div class="app-logo">LOGO</div>
      <div>Aplikacja Sondowa</div>
    </div>

    <div class="app-userbox">
      <div class="app-name" id="currentUser">Jan Kowalski</div>
      <button class="app-avatar-btn" id="btnUser" aria-haspopup="menu" aria-expanded="false">üë§</button>
      <div class="app-usermenu" id="userMenu" role="menu" aria-label="Menu u≈ºytkownika">
        <button data-action="change-password">Zmie≈Ñ has≈Ço</button>
        <button data-action="account-settings">Ustawienia konta</button>
        <button data-action="logout">Wyloguj</button>
      </div>
    </div>
  </header>

   <div class="app-layout">
    <aside class="app-sidebar" id="sidebar">
      <button class="app-nav-btn" data-view="moje-sondy">Moje sondy</button>
      <button class="app-nav-btn" data-view="dodaj-sonde">Dodaj sondƒô</button>
      <button class="app-nav-btn" data-view="edytuj-sonde">Edytuj sondƒô</button>
      <button class="app-nav-btn" data-view="statystyki">Statystyki</button>
      <button class="app-nav-btn app-nav-btn--logout" data-view="wyloguj">Wyloguj</button>
    </aside>

    <main id="content" class="app-content" aria-live="polite">Wczytywanie‚Ä¶</main>
  </div>

  <!-- FOOTER -->
  <footer class="app-footer">¬© 2025 Twoja Aplikacja Sondowa ‚Ä¢ <a class="link" href="#">Kontakt</a></footer>
</body>

  <script src="/skrypt/app.js"></script>
<script>
  // ====== USTAWIENIA U≈ªYTKOWNIKA (imiƒô z localStorage) ======
  (function fillUserName(){
    try {
      const name = localStorage.getItem("userFullname") || "Jan Kowalski";
      document.getElementById("currentUser").textContent = name;
    } catch {}
  })();

  // ====== MENU U≈ªYTKOWNIKA ======
  (function userMenu(){
    const btn = document.getElementById("btnUser");
    const menu = document.getElementById("userMenu");
    btn.addEventListener("click", () => {
      const open = menu.classList.toggle("open");
      btn.setAttribute("aria-expanded", open ? "true" : "false");
    });
    document.addEventListener("click", (e) => {
      if (!menu.contains(e.target) && e.target !== btn) menu.classList.remove("open");
    });

    menu.addEventListener("click", (e) => {
      const act = e.target?.dataset?.action;
      if (!act) return;
      if (act === "logout") logoutUser();
      if (act === "change-password") window.location.href = "/resetHasla.html";
      if (act === "account-settings") alert("Ustawienia konta ‚Äì w przygotowaniu.");
    });
  })();

  // ====== SIDEBAR / HAMBURGER ======
  (function sidebar(){
    const sidebar = document.getElementById("sidebar");
    const burger = document.getElementById("btnHamburger");
    burger.addEventListener("click", () => sidebar.classList.toggle("open"));
    sidebar.addEventListener("click", (e) => {
      if (e.target.matches(".app-nav-btn")) sidebar.classList.remove("open");
    });
  })();

  // ====== FUNKCJA INICJALIZUJƒÑCA FORMULARZ "DODAJ SONDƒò" ======
  function initDodajSonde(root) {
    const form      = root.querySelector('#formAddProbe');
    if (!form) return;

    const nameEl    = root.querySelector('#probeName');
    const urlEl     = root.querySelector('#probeUrl');
    const intValEl  = root.querySelector('#intervalValue');
    const intUnitEl = root.querySelector('#intervalUnit');
    const promptEl  = root.querySelector('#llmPrompt');
    const msgEl     = root.querySelector('#formMessages');
    const counterEl = root.querySelector('#promptCounter');
    const btnAdd    = root.querySelector('#btnAdd');

    // licznik znak√≥w
    const updateCounter = () => {
      counterEl.textContent = (promptEl.value?.length || 0) + ' / ' + promptEl.maxLength;
    };
    promptEl?.addEventListener('input', updateCounter);
    updateCounter();

    const isValidUrl = (v) => {
      try { const u = new URL(v); return u.protocol === 'http:' || u.protocol === 'https:'; }
      catch { return false; }
    };
    const showMessage = (t, ok=false) => {
      msgEl.textContent = t;
      msgEl.className = 'messages ' + (ok ? 'msg-ok' : 'msg-error');
    };
    const clearErrors = () => {
      [nameEl, urlEl, intValEl, intUnitEl].forEach(el => el?.classList.remove('error'));
      showMessage('');
    };

    form.addEventListener('reset', () => setTimeout(() => { updateCounter(); clearErrors(); }, 0));

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearErrors();

      const nazwa = nameEl.value.trim();
      const url   = urlEl.value.trim();
      const val   = Number(intValEl.value);
      const unit  = intUnitEl.value; // 'second' | 'minute' | 'hour'
      const llm_prompt = (promptEl.value || '').trim() || null;

      if (!nazwa) { nameEl.classList.add('error'); return showMessage('Podaj nazwƒô sondy.'); }
      if (!isValidUrl(url)) { urlEl.classList.add('error'); return showMessage('Podaj poprawny URL (http/https).'); }
      if (!val || val < 1) { intValEl.classList.add('error'); return showMessage('Czƒôstotliwo≈õƒá musi byƒá ‚â• 1.'); }
      if (!unit) { intUnitEl.classList.add('error'); return showMessage('Wybierz jednostkƒô czasu.'); }

      const multiplier = unit === 'hour' ? 3600 : (unit === 'minute' ? 60 : 1);
      const interval_seconds = val * multiplier;

      const payload = { name: nazwa, url, interval_seconds, prompt: llm_prompt };

      try {
        btnAdd.disabled = true;
        const res = await fetch('/api/monitory', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }, // JWT doda siƒô automatycznie
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err?.message || 'Nie uda≈Ço siƒô dodaƒá sondy.');
        }
        showMessage('Sonda zosta≈Ça dodana.', true);
        form.reset(); updateCounter();
      } catch (err) {
        showMessage(err.message || 'WystƒÖpi≈Ç b≈ÇƒÖd. Spr√≥buj ponownie.');
      } finally {
        btnAdd.disabled = false;
      }
    });
  }
  function msRenderCard(item){
    const interval = (s) => {
      if (!s || s < 60) return `${s ?? '?'} s`;
      if (s < 3600)     return `${Math.round(s/60)} min`;
      return `${(s/3600).toFixed(1)} h`;
    };
    const last = item.last_check_at ? new Date(item.last_check_at).toLocaleString() : '‚Äî';
    const statusBadge =
      item.status === 'paused' ? 'Wstrzymana' :
      item.status === 'error'  ? 'B≈ÇƒÖd' :
      'Aktywna';

    return `
      <div class="card" data-id="${item.id}">
        <div class="card-body" style="padding:18px">
          <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
            <div>
              <div style="font-weight:700; font-size:1.05rem">${item.name}</div>
              <div class="hint" style="margin-top:4px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.url}</div>
            </div>
            <div class="hint" style="text-align:right; min-width:180px;">
              <div><strong>Interwa≈Ç:</strong> ${interval(item.interval_seconds)}</div>
              <div><strong>Ostatnie sprawdz.</strong> ${last}</div>
              <div><strong>Status:</strong> ${statusBadge}</div>
            </div>
          </div>

          <div class="row" style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn" data-action="toggle">${item.status==='paused' ? 'Uruchom' : 'Wstrzymaj'}</button>
            <button class="btn" data-action="logs">Logi</button>
            <button class="btn" data-action="delete" style="background:linear-gradient(135deg, var(--accent-red), #ff8a80)">Usu≈Ñ</button>
          </div>
        </div>
      </div>
    `;
  }

  // === WIDOK "MOJE SONDY" (pe≈Çna, gotowa funkcja) ===
  function initMojeSondy(root){
    const listEl   = root.querySelector('#msList');
    if (!listEl) return; // nie jeste≈õmy na tym widoku

    const emptyEl  = root.querySelector('#msEmpty');
    const infoEl   = root.querySelector('#msInfo');
    const searchEl = root.querySelector('#msSearch');
    const statusEl = root.querySelector('#msStatus');
    const limitEl  = root.querySelector('#msLimit');
    const refresh  = root.querySelector('#msRefresh');
    const prevBtn  = root.querySelector('#msPrev');
    const nextBtn  = root.querySelector('#msNext');

    let page = 1;
    let total = 0;
    let pageSize = Number(limitEl?.value || 20);
    let currentReq = null; // do anulowania fetch√≥w

    const qs = () => {
      const p = new URLSearchParams();
      p.set('mine', '1');
      if (searchEl?.value?.trim()) p.set('q', searchEl.value.trim());
      if (statusEl?.value) p.set('status', statusEl.value);
      p.set('page',  String(page));
      p.set('limit', String(pageSize));
      return p.toString();
    };

    const setLoading = (on) => {
      if (infoEl) infoEl.textContent = on ? '≈Åadowanie‚Ä¶' : '';
      // nie blokujemy p√≥l szukania/filtru podczas ≈Çadowania
      refresh && (refresh.disabled = !!on);
      prevBtn && (prevBtn.disabled = !!on || page <= 1);
      nextBtn && (nextBtn.disabled = !!on);
    };

    const renderItems = (items) => {
      listEl.textContent = '';
      const frag = document.createDocumentFragment();
      for (const it of items){
        const wrap = document.createElement('div');
        wrap.innerHTML = msRenderCard(it).trim();
        frag.appendChild(wrap.firstElementChild);
      }
      listEl.appendChild(frag);
      emptyEl && (emptyEl.style.display = items.length ? 'none' : 'block');
    };

    const filterClient = (items) => {
      const term = (searchEl?.value || '').trim().toLowerCase();
      const st   = statusEl?.value || '';
      const getText = (it) => [it.name, it.nazwa, it.title, it.tytul, it.url, it.link, it.adres]
        .filter(Boolean).join(' ').toLowerCase();
      const getStatus = (it) => (it.status ?? it.state ?? (it.aktywny === false ? 'paused' : 'active'));
      let out = items;
      if (term) out = out.filter(it => getText(it).includes(term));
      if (st)   out = out.filter(it => String(getStatus(it)) === st);
      return out;
    };

    async function load(){
      // je≈õli trwa poprzedni fetch ‚Äî anuluj go
      if (currentReq) { currentReq.abort(); currentReq = null; }
      const ac = new AbortController();
      currentReq = ac;

      setLoading(true);
      try {
        const jwt = localStorage.getItem('jwt') || '';
        const res = await fetch('/api/monitory?' + qs(), {
          cache: 'no-store',
          headers: jwt ? { 'Authorization': `Bearer ${jwt}` } : {},
          signal: ac.signal
        });
        if (!res.ok) throw new Error('Nie uda≈Ço siƒô pobraƒá listy.');
        const data = await res.json();

        const rawItems = Array.isArray(data?.items) ? data.items
                       : (Array.isArray(data) ? data : []);
        total = Number(data?.total ?? rawItems.length);

        let items = filterClient(rawItems);
        const targetLimit = Number(limitEl?.value || pageSize || 20);
        if (items.length > targetLimit) items = items.slice(0, targetLimit);

        renderItems(items);

        const pageSizeGuess = Number(data?.pageSize ?? targetLimit);
        const from = (page-1)*pageSizeGuess + (items.length ? 1 : 0);
        const to   = (page-1)*pageSizeGuess + items.length;
        if (infoEl) infoEl.textContent = items.length ? `Pozycje ${from}‚Äì${to} z ${total}` : '';

        if (prevBtn) prevBtn.disabled = page <= 1;
        if (nextBtn) nextBtn.disabled = to >= total;
      } catch (e){
        if (e.name === 'AbortError') return; // ignoruj anulowany fetch
        console.error(e);
        listEl.innerHTML = `<div class="hint">B≈ÇƒÖd: ${e.message || e}</div>`;
        emptyEl && (emptyEl.style.display = 'none');
      } finally {
        if (currentReq === ac) currentReq = null;
        setLoading(false);
      }
    }

    // === HANDLERY UI ===
    const debounce = (fn, ms=400) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    limitEl?.addEventListener('change', () => { pageSize = Number(limitEl.value) || 10; page = 1; load(); });
    searchEl?.addEventListener('input', debounce(() => { page = 1; load(); }, 400));
    statusEl?.addEventListener('change', () => { page = 1; load(); });
    refresh?.addEventListener('click', () => load());
    prevBtn?.addEventListener('click', () => { if (page > 1){ page--; load(); } });
    nextBtn?.addEventListener('click', () => { page++; load(); });

    // === AKCJE NA KARTACH (usu≈Ñ / wstrzymaj / logi) ===
    listEl.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;

      const card   = btn.closest('.card[data-id]');
      const id     = card?.dataset?.id;
      const action = btn.dataset.action;
      if (!id || !action) return;

      try {
        const jwt = localStorage.getItem('jwt');
        if (!jwt) throw new Error('Brak tokenu. Zaloguj siƒô.');
        const auth = { 'Authorization': `Bearer ${jwt}` };

        if (action === 'delete'){
          if (!confirm('Na pewno usunƒÖƒá sondƒô?')) return;
          let r = await fetch(`/api/monitory/${id}`, { method: 'DELETE', headers: auth });
          if (r.status === 404) {
            r = await fetch(`/api/monitory?id=${encodeURIComponent(id)}`, { method: 'DELETE', headers: auth });
          }
          if (!r.ok) throw new Error('Nie uda≈Ço siƒô usunƒÖƒá sondy.');
          await load();
          return;
        }

        if (action === 'toggle'){
          // toggle pause/resume
          let r = await fetch(`/api/monitory/${id}/pause`, { method: 'POST', headers: auth });
          if (r.status === 404) {
            r = await fetch(`/api/monitory/${id}`, {
              method: 'PATCH',
              headers: { ...auth, 'Content-Type': 'application/json' },
              body: JSON.stringify({ toggle: true })
            });
          }
          if (!r.ok) throw new Error('Nie uda≈Ço siƒô zmieniƒá statusu.');
          await load();
          return;
        }

        if (action === 'logs'){
          window.open(`/api/monitory/${id}/logs`, '_blank');
          return;
        }
      } catch (err){
        alert(err.message || 'Operacja nie powiod≈Ça siƒô.');
      }
    });

    // === START ===
    load();
  }
  // ====== DYNAMICZNE WIDOKI ======
  async function loadView(name){
    const content = document.getElementById("content");
    content.textContent = "Wczytywanie‚Ä¶";
    try {
      if (name === "wyloguj") { logoutUser(); return; }

      const res = await fetch(`/widoki/${name}.html`, { cache: "no-store" });
      if (!res.ok) throw new Error("Brak widoku");

      const html = await res.text();
      content.innerHTML = html;

      // pod≈ÇƒÖczanie logik do widok√≥w
      initDodajSonde(content); // ju≈º by≈Ço
      initMojeSondy(content);  // ‚¨Ö NOWE

      // aktywny przycisk + hash
      document.querySelectorAll(".app-nav-btn")
        .forEach(b => b.dataset.active = (b.dataset.view === name));
      history.replaceState(null, "", `#view=${encodeURIComponent(name)}`);
    } catch (e) {
      console.error("B≈ÇƒÖd ≈Çadowania widoku:", e);
      content.innerHTML = `<div class="card"><p>Nie uda≈Ço siƒô wczytaƒá widoku <strong>${name}</strong>.</p></div>`;
    }
  }


  // ====== OBS≈ÅUGA KLIKNIƒòƒÜ W SIDEBAR ======
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-view]");
    if (!btn) return;
    const view = btn.getAttribute("data-view");
    loadView(view);
  });

  // ====== START: wczytaj widok z hash lub domy≈õlnie ‚Äûmoje-sondy‚Äù ======
  (function boot(){
    const fromHash = location.hash.match(/view=([^&]+)/)?.[1];
    loadView(fromHash || "moje-sondy");
  })();
</script>
</html>


