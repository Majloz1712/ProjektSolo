<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trackly ‚Äì Panel</title>
  <link rel="stylesheet" href="/styl/styles.css" />

  <!-- Minimalne style layoutu (nie gryzƒÖ siƒô z Twoim styles.css) -->
  
</head>
<body class="app">
  <header class="app-header">
    <div class="app-brand">
      <button class="app-hamburger" id="btnHamburger" aria-label="Menu">&#9776;</button>
      <div class="app-logo">LOGO</div>
      <div>Trackly</div>
    </div>

    <div class="app-userbox">
      <div class="app-name" id="currentUser">Jan Kowalski</div>
      <button class="app-avatar-btn" id="btnUser" aria-haspopup="menu" aria-expanded="false">üë§</button>
      <div class="app-usermenu" id="userMenu" role="menu" aria-label="Menu u≈ºytkownika">
        <button data-action="change-password">Zmie≈Ñ has≈Ço</button>
        <button data-action="account-settings">Ustawienia konta</button>
        <button data-action="logout">Wyloguj</button>
      </div>
    </div>
  </header>

   <div class="app-layout">
    <aside class="app-sidebar" id="sidebar">
      <button class="app-nav-btn" data-view="moje-sondy">Moje sondy</button>
      <button class="app-nav-btn" data-view="dodaj-sonde">Dodaj sondƒô</button>
<button class="app-nav-btn" data-view="statystyki">Statystyki</button>
        <button class="app-nav-btn" data-view="historia">Historia</button>
      <button class="app-nav-btn app-nav-btn--logout" data-view="wyloguj">Wyloguj</button>
    </aside>

    <main id="content" class="app-content" aria-live="polite">Wczytywanie‚Ä¶</main>
  </div>

  <!-- FOOTER -->
  <footer class="app-footer">¬© 2025 Trackly ‚Ä¢ <a class="link" href="#">Kontakt</a></footer>
</body>

  <script src="/skrypt/app.js"></script>
<script>
  // ====== USTAWIENIA U≈ªYTKOWNIKA (imiƒô z localStorage) ======
  (function fillUserName(){
    try {
      const name = localStorage.getItem("userFullname") || "Jan Kowalski";
      document.getElementById("currentUser").textContent = name;
    } catch {}
  })();

  // ====== MENU U≈ªYTKOWNIKA ======
  (function userMenu(){
    const btn = document.getElementById("btnUser");
    const menu = document.getElementById("userMenu");
    btn.addEventListener("click", () => {
      const open = menu.classList.toggle("open");
      btn.setAttribute("aria-expanded", open ? "true" : "false");
    });
    document.addEventListener("click", (e) => {
      if (!menu.contains(e.target) && e.target !== btn) menu.classList.remove("open");
    });

    menu.addEventListener("click", (e) => {
      const act = e.target?.dataset?.action;
      if (!act) return;
      if (act === "logout") logoutUser();
      if (act === "change-password") window.location.href = "/resetHasla.html";
      if (act === "account-settings") {
  const name = localStorage.getItem("userFullname") || "‚Äî";
  const email = localStorage.getItem("userEmail") || "‚Äî";

  createModal({
    title: "Ustawienia konta",
    contentHtml: `
      <div class="hint" style="margin-bottom:12px;">
        Poni≈ºej podstawowe informacje o koncie (reszta opcji mo≈ºe doj≈õƒá p√≥≈∫niej).
      </div>

      <div class="card" style="padding:14px; margin-bottom:12px;">
        <div style="display:grid; gap:8px;">
          <div><strong>Imiƒô i nazwisko:</strong> ${name}</div>
          <div><strong>E-mail:</strong> ${email}</div>
        </div>
      </div>

      <div class="row row--actions" style="margin-top:10px;">
        <button class="btn btn--sm" type="button" id="accChangePass">Zmie≈Ñ has≈Ço</button>
        <button class="btn btn--ghost btn--sm" type="button" id="accLogout">Wyloguj</button>
      </div>
    `
  });

  // obs≈Çuga przycisk√≥w modala
  setTimeout(() => {
    document.getElementById("accChangePass")?.addEventListener("click", () => {
      window.location.href = "/resetHasla.html";
    });
    document.getElementById("accLogout")?.addEventListener("click", () => {
      logoutUser();
    });
  }, 0);
}

    });
  })();

  // ====== SIDEBAR / HAMBURGER ======
  (function sidebar(){
    const sidebar = document.getElementById("sidebar");
    const burger = document.getElementById("btnHamburger");
    burger.addEventListener("click", () => sidebar.classList.toggle("open"));
    sidebar.addEventListener("click", (e) => {
      if (e.target.matches(".app-nav-btn")) sidebar.classList.remove("open");
    });
  })();

  
// ====== MODAL + EDYCJA SONDY (UI) ======
function createModal({ title, contentHtml }){
  const wrap = document.createElement('div');
  wrap.className = 'modal-backdrop';
  wrap.innerHTML = `
    <div class="card modal" role="dialog" aria-modal="true" aria-label="${title}">
      <div class="modal-top">
        <div class="modal-title">${title}</div>
        <button class="icon-btn" type="button" data-modal-close aria-label="Zamknij">‚úï</button>
      </div>
      <div class="modal-body">${contentHtml}</div>
    </div>
  `;
  const close = () => wrap.remove();
  wrap.addEventListener('click', (e) => { if (e.target === wrap) close(); });
  wrap.querySelector('[data-modal-close]')?.addEventListener('click', close);

  const esc = (ev) => { if (ev.key === 'Escape'){ close(); document.removeEventListener('keydown', esc); } };
  document.addEventListener('keydown', esc);

  document.body.appendChild(wrap);
  return { el: wrap, close };
}

function intervalPartsFromSeconds(seconds){
  const s = Number(seconds || 0);
  if (!s || s < 60) return { value: s || 1, unit: 'second' };
  if (s % 3600 === 0) return { value: s / 3600, unit: 'hour' };
  if (s % 60 === 0)   return { value: s / 60, unit: 'minute' };
  return { value: s, unit: 'second' };
}

function secondsFromInterval(value, unit){
  const v = Number(value);
  const multiplier = unit === 'hour' ? 3600 : (unit === 'minute' ? 60 : 1);
  return v * multiplier;
}

async function fetchMonitorDetails(id){
  const jwt = localStorage.getItem('jwt') || '';
  const headers = jwt ? { 'Authorization': `Bearer ${jwt}` } : {};
  let r = await fetch(`/api/monitory/${id}`, { headers, cache: 'no-store' });
  if (r.status === 404) r = await fetch(`/api/monitory?id=${encodeURIComponent(id)}`, { headers, cache: 'no-store' });
  if (!r.ok) throw new Error('Nie uda≈Ço siƒô pobraƒá danych sondy.');
  const data = await r.json().catch(() => ({}));
  return data?.item || data;
}

function renderEditFormHTML(probe){
  const p = probe || {};
  const parts = intervalPartsFromSeconds(p.interval_seconds);
  const prompt = (p.prompt || p.llm_prompt || '') ?? '';
  const type = p.type || p.scan_type || 'screenshot';
  const esc = (s) => String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('"','&quot;');

  return `
    <form id="formEditProbe" novalidate>
      <div class="field">
        <label for="editName">Nazwa sondy</label>
        <input id="editName" class="input" name="name" type="text" maxlength="150" required value="${esc(p.name)}" />
      </div>

      <div class="field">
        <label for="editUrl">Link do strony (URL)</label>
        <input id="editUrl" class="input" name="url" type="url" required value="${esc(p.url)}" />
      </div>

      <div class="field">
        <label for="editType">Typ skanowania</label>
        <select id="editType" class="input" name="type" required>
          <option value="screenshot" ${type === 'screenshot' ? 'selected' : ''}>Screenshot (wizualnie)</option>
          <option value="html" ${type === 'html' ? 'selected' : ''}>Tradycyjna (tekst/HTML)</option>
        </select>
      </div>

      <div class="field">
        <label for="editIntervalValue">Co ile wykonywaƒá sondƒô</label>
        <div class="row">
          <input id="editIntervalValue" class="input" name="interval_value" type="number" min="1" step="1" required value="${parts.value}" />
          <select id="editIntervalUnit" class="input" name="interval_unit" required>
            <option value="minute" ${parts.unit === 'minute' ? 'selected' : ''}>minut(y)</option>
            <option value="hour" ${parts.unit === 'hour' ? 'selected' : ''}>godzin(y)</option>
            <option value="second" ${parts.unit === 'second' ? 'selected' : ''}>sekund(y)</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="editPrompt">Dodatkowy prompt (opcjonalnie)</label>
        <textarea id="editPrompt" class="input" name="prompt" rows="6" maxlength="1200">${esc(prompt)}</textarea>
        <div class="row" style="justify-content:flex-end; margin-top:8px;">
          <div class="hint" id="editPromptCounter">0 / 1200</div>
        </div>
      </div>

      <div class="messages" id="editMessages" aria-live="polite"></div>

      <div class="row row--actions" style="margin-top:14px;">
        <button type="button" class="btn btn--ghost btn--sm" data-cancel>Anuluj</button>
        <button type="submit" class="btn btn--sm" data-submit>Zatwierd≈∫</button>
      </div>
    </form>
  `;
}

function initEditForm(modalRoot, { id, onDone, onCancel }){
  const form = modalRoot.querySelector('#formEditProbe');
  if (!form) return;

  const nameEl = form.querySelector('#editName');
  const urlEl  = form.querySelector('#editUrl');
  const typeEl = form.querySelector('#editType');
  const intVEl = form.querySelector('#editIntervalValue');
  const intUEl = form.querySelector('#editIntervalUnit');
  const promptEl = form.querySelector('#editPrompt');
  const msgEl  = form.querySelector('#editMessages');
  const counterEl = form.querySelector('#editPromptCounter');
  const submitBtn = form.querySelector('[data-submit]');
  const cancelBtn = form.querySelector('[data-cancel]');

  const updateCounter = () => { counterEl.textContent = `${(promptEl.value?.length || 0)} / 1200`; };
  promptEl.addEventListener('input', updateCounter);
  updateCounter();

  const showMessage = (t, ok=false) => {
    msgEl.textContent = t;
    msgEl.className = 'messages ' + (ok ? 'msg-ok' : 'msg-error');
  };
  const clearErrors = () => {
    [nameEl, urlEl, typeEl, intVEl, intUEl].forEach(el => el?.classList.remove('error'));
    showMessage('');
  };

  cancelBtn.addEventListener('click', () => onCancel?.());

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearErrors();

    const name = (nameEl.value || '').trim();
    const url  = (urlEl.value || '').trim();
    const type = (typeEl.value || '').trim();
    const val  = Number(intVEl.value);
    const unit = intUEl.value;
    const prompt = (promptEl.value || '').trim() || null;

    // prosta walidacja
    if (!name) { nameEl.classList.add('error'); return showMessage('Podaj nazwƒô sondy.'); }
    try { const u = new URL(url); if (!['http:','https:'].includes(u.protocol)) throw 0; }
    catch { urlEl.classList.add('error'); return showMessage('Podaj poprawny URL (http/https).'); }
    if (!type) { typeEl.classList.add('error'); return showMessage('Wybierz typ skanowania.'); }
    if (!val || val < 1) { intVEl.classList.add('error'); return showMessage('Czƒôstotliwo≈õƒá musi byƒá ‚â• 1.'); }

    const interval_seconds = secondsFromInterval(val, unit);
    const payload = { name, url, type, interval_seconds, prompt };

    const jwt = localStorage.getItem('jwt') || '';
    const headers = {
      'Content-Type': 'application/json',
      ...(jwt ? { 'Authorization': `Bearer ${jwt}` } : {})
    };

    try {
      submitBtn.disabled = true;
      let r = await fetch(`/api/monitory/${id}`, { method: 'PATCH', headers, body: JSON.stringify(payload) });
      if (r.status === 404) r = await fetch(`/api/monitory?id=${encodeURIComponent(id)}`, { method: 'PATCH', headers, body: JSON.stringify(payload) });
      if (!r.ok) {
        const err = await r.json().catch(() => ({}));
        throw new Error(err?.message || 'Nie uda≈Ço siƒô zapisaƒá zmian.');
      }
      showMessage('Zapisano zmiany.', true);
      onDone?.();
    } catch (err){
      showMessage(err.message || 'WystƒÖpi≈Ç b≈ÇƒÖd.');
    } finally {
      submitBtn.disabled = false;
    }
  });
}


  // ====== FUNKCJA INICJALIZUJƒÑCA FORMULARZ "DODAJ SONDƒò" ======
  function initDodajSonde(root) {
    const form      = root.querySelector('#formAddProbe');
    if (!form) return;

    const nameEl    = root.querySelector('#probeName');
    const urlEl     = root.querySelector('#probeUrl');
    const typeEl    = root.querySelector('#scanType');
    const intValEl  = root.querySelector('#intervalValue');
    const intUnitEl = root.querySelector('#intervalUnit');
    const promptEl  = root.querySelector('#llmPrompt');
    const msgEl     = root.querySelector('#formMessages');
    const counterEl = root.querySelector('#promptCounter');
    const btnAdd    = root.querySelector('#btnAdd');

    // licznik znak√≥w
    const updateCounter = () => {
      counterEl.textContent = (promptEl.value?.length || 0) + ' / ' + promptEl.maxLength;
    };
    promptEl?.addEventListener('input', updateCounter);
    updateCounter();

    const isValidUrl = (v) => {
      try { const u = new URL(v); return u.protocol === 'http:' || u.protocol === 'https:'; }
      catch { return false; }
    };
    const showMessage = (t, ok=false) => {
      msgEl.textContent = t;
      msgEl.className = 'messages ' + (ok ? 'msg-ok' : 'msg-error');
    };
    const clearErrors = () => {
      [nameEl, urlEl, intValEl, intUnitEl].forEach(el => el?.classList.remove('error'));
      showMessage('');
    };

    form.addEventListener('reset', () => setTimeout(() => { updateCounter(); clearErrors(); }, 0));

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearErrors();

      const nazwa = nameEl.value.trim();
      const url   = urlEl.value.trim();
      const val   = Number(intValEl.value);
      const unit  = intUnitEl.value; // 'second' | 'minute' | 'hour'
      const llm_prompt = (promptEl.value || '').trim() || null;
      const type  = (typeEl?.value || 'screenshot');

      if (!nazwa) { nameEl.classList.add('error'); return showMessage('Podaj nazwƒô sondy.'); }
      if (!isValidUrl(url)) { urlEl.classList.add('error'); return showMessage('Podaj poprawny URL (http/https).'); }
      if (!val || val < 1) { intValEl.classList.add('error'); return showMessage('Czƒôstotliwo≈õƒá musi byƒá ‚â• 1.'); }
      if (typeEl && !type) { typeEl.classList.add('error'); return showMessage('Wybierz typ skanowania.'); }
      if (!unit) { intUnitEl.classList.add('error'); return showMessage('Wybierz jednostkƒô czasu.'); }

      const multiplier = unit === 'hour' ? 3600 : (unit === 'minute' ? 60 : 1);
      const interval_seconds = val * multiplier;

      const payload = { name: nazwa, url, type, interval_seconds, prompt: llm_prompt };

      try {
        btnAdd.disabled = true;
        const res = await fetch('/api/monitory', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }, // JWT doda siƒô automatycznie
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err?.message || 'Nie uda≈Ço siƒô dodaƒá sondy.');
        }
        showMessage('Sonda zosta≈Ça dodana.', true);
        form.reset(); updateCounter();
      } catch (err) {
        showMessage(err.message || 'WystƒÖpi≈Ç b≈ÇƒÖd. Spr√≥buj ponownie.');
      } finally {
        btnAdd.disabled = false;
      }
    });
  }
function msRenderCard(item){
  const interval = (s) => {
    if (!s || s < 60) return `${s ?? '?'} s`;
    if (s < 3600)     return `${Math.round(s/60)} min`;
    return `${(s/3600).toFixed(1)} h`;
  };

  const last = item.last_check_at ? new Date(item.last_check_at).toLocaleString() : '‚Äî';

  const statusBadge =
    item.status === 'paused' ? 'Wstrzymana' :
    item.status === 'error'  ? 'B≈ÇƒÖd' :
    'Aktywna';

  const scanTypeRaw = item.type || item.scan_type || item.tryb_skanu || "screenshot";
  const scanTypeLabel =
    scanTypeRaw === "static" || scanTypeRaw === "html" ? "tradycyjna" : "screenshot";

  // zamiast pe≈Çnego URL poka≈º tylko host (kr√≥tko) ‚Äî nie wypycha UI
  let host = "‚Äî";
  try { host = new URL(item.url).host; } catch {}

  return `
    <div class="card" data-id="${item.id}">
      <div class="card-body" style="padding:18px">
        <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
          <div style="min-width:0;">
            <div style="font-weight:700; font-size:1.05rem">${item.name}</div>
            <div class="hint" style="margin-top:4px;">${host}</div>
          </div>

          <div class="hint" style="text-align:right; min-width:220px;">
            <div><strong>Interwa≈Ç:</strong> ${interval(item.interval_seconds)}</div>
            <div><strong>Ostatnie sprawdz.</strong> ${last}</div>
            <div><strong>Status:</strong> ${statusBadge}</div>
            <div><strong>Typ:</strong> ${scanTypeLabel}</div>
          </div>
        </div>

        <div class="row row--actions" style="margin-top:14px;">
          <button class="btn btn--sm" data-action="toggle">${item.status==='paused' ? 'Uruchom' : 'Wstrzymaj'}</button>
          <button class="btn btn--ghost btn--sm" data-action="edit">Edytuj</button>
          <button class="btn btn--danger btn--sm" data-action="delete">Usu≈Ñ</button>
        </div>
      </div>
    </div>
  `;
}


  // === WIDOK "MOJE SONDY" (pe≈Çna, gotowa funkcja) ===
  function initMojeSondy(root){
    const listEl   = root.querySelector('#msList');
    if (!listEl) return; // nie jeste≈õmy na tym widoku

    const emptyEl  = root.querySelector('#msEmpty');
    const infoEl   = root.querySelector('#msInfo');
    const searchEl = root.querySelector('#msSearch');
    const statusEl = root.querySelector('#msStatus');
    const limitEl  = root.querySelector('#msLimit');
    const refresh  = root.querySelector('#msRefresh');
    const prevBtn  = root.querySelector('#msPrev');
    const nextBtn  = root.querySelector('#msNext');

    let page = 1;
    let total = 0;
    let pageSize = Number(limitEl?.value || 20);
    let currentReq = null; // do anulowania fetch√≥w

    const qs = () => {
      const p = new URLSearchParams();
      p.set('mine', '1');
      if (searchEl?.value?.trim()) p.set('q', searchEl.value.trim());
      if (statusEl?.value) p.set('status', statusEl.value);
      p.set('page',  String(page));
      p.set('limit', String(pageSize));
      return p.toString();
    };

    const setLoading = (on) => {
      if (infoEl) infoEl.textContent = on ? '≈Åadowanie‚Ä¶' : '';
      // nie blokujemy p√≥l szukania/filtru podczas ≈Çadowania
      refresh && (refresh.disabled = !!on);
      prevBtn && (prevBtn.disabled = !!on || page <= 1);
      nextBtn && (nextBtn.disabled = !!on);
    };

    const renderItems = (items) => {
      listEl.textContent = '';
      const frag = document.createDocumentFragment();
      for (const it of items){
        const wrap = document.createElement('div');
        wrap.innerHTML = msRenderCard(it).trim();
        frag.appendChild(wrap.firstElementChild);
      }
      listEl.appendChild(frag);
      emptyEl && (emptyEl.style.display = items.length ? 'none' : 'block');
    };

    const filterClient = (items) => {
      const term = (searchEl?.value || '').trim().toLowerCase();
      const st   = statusEl?.value || '';
      const getText = (it) => [it.name, it.nazwa, it.title, it.tytul, it.url, it.link, it.adres]
        .filter(Boolean).join(' ').toLowerCase();
      const getStatus = (it) => (it.status ?? it.state ?? (it.aktywny === false ? 'paused' : 'active'));
      let out = items;
      if (term) out = out.filter(it => getText(it).includes(term));
      if (st)   out = out.filter(it => String(getStatus(it)) === st);
      return out;
    };

    async function load(){
      // je≈õli trwa poprzedni fetch ‚Äî anuluj go
      if (currentReq) { currentReq.abort(); currentReq = null; }
      const ac = new AbortController();
      currentReq = ac;

      setLoading(true);
      try {
        const jwt = localStorage.getItem('jwt') || '';
        const res = await fetch('/api/monitory?' + qs(), {
          cache: 'no-store',
          headers: jwt ? { 'Authorization': `Bearer ${jwt}` } : {},
          signal: ac.signal
        });
        if (!res.ok) throw new Error('Nie uda≈Ço siƒô pobraƒá listy.');
        const data = await res.json();

        const rawItems = Array.isArray(data?.items) ? data.items
                       : (Array.isArray(data) ? data : []);
        total = Number(data?.total ?? rawItems.length);

        let items = filterClient(rawItems);
        const targetLimit = Number(limitEl?.value || pageSize || 20);
        if (items.length > targetLimit) items = items.slice(0, targetLimit);

        renderItems(items);

        const pageSizeGuess = Number(data?.pageSize ?? targetLimit);
        const from = (page-1)*pageSizeGuess + (items.length ? 1 : 0);
        const to   = (page-1)*pageSizeGuess + items.length;
        if (infoEl) infoEl.textContent = items.length ? `Pozycje ${from}‚Äì${to} z ${total}` : '';

        if (prevBtn) prevBtn.disabled = page <= 1;
        if (nextBtn) nextBtn.disabled = to >= total;
      } catch (e){
        if (e.name === 'AbortError') return; // ignoruj anulowany fetch
        console.error(e);
        listEl.innerHTML = `<div class="hint">B≈ÇƒÖd: ${e.message || e}</div>`;
        emptyEl && (emptyEl.style.display = 'none');
      } finally {
        if (currentReq === ac) currentReq = null;
        setLoading(false);
      }
    }

    // === HANDLERY UI ===
    const debounce = (fn, ms=400) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    limitEl?.addEventListener('change', () => { pageSize = Number(limitEl.value) || 10; page = 1; load(); });
    searchEl?.addEventListener('input', debounce(() => { page = 1; load(); }, 400));
    statusEl?.addEventListener('change', () => { page = 1; load(); });
    refresh?.addEventListener('click', () => load());
    prevBtn?.addEventListener('click', () => { if (page > 1){ page--; load(); } });
    nextBtn?.addEventListener('click', () => { page++; load(); });

    // === AKCJE NA KARTACH (usu≈Ñ / wstrzymaj / logi) ===
    listEl.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;

      const card   = btn.closest('.card[data-id]');
      const id     = card?.dataset?.id;
      const action = btn.dataset.action;
      if (!id || !action) return;

      try {
        const jwt = localStorage.getItem('jwt');
        if (!jwt) throw new Error('Brak tokenu. Zaloguj siƒô.');
        const auth = { 'Authorization': `Bearer ${jwt}` };

        if (action === 'delete'){
          if (!confirm('Na pewno usunƒÖƒá sondƒô?')) return;
          let r = await fetch(`/api/monitory/${id}`, { method: 'DELETE', headers: auth });
          if (r.status === 404) {
            r = await fetch(`/api/monitory?id=${encodeURIComponent(id)}`, { method: 'DELETE', headers: auth });
          }
          if (!r.ok) throw new Error('Nie uda≈Ço siƒô usunƒÖƒá sondy.');
          await load();
          return;
        }

        if (action === 'toggle'){
          // toggle pause/resume
          let r = await fetch(`/api/monitory/${id}/pause`, { method: 'POST', headers: auth });
          if (r.status === 404) {
            r = await fetch(`/api/monitory/${id}`, {
              method: 'PATCH',
              headers: { ...auth, 'Content-Type': 'application/json' },
              body: JSON.stringify({ toggle: true })
            });
          }
          if (!r.ok) throw new Error('Nie uda≈Ço siƒô zmieniƒá statusu.');
          await load();
          return;
        }


if (action === 'edit'){
  // pobierz pe≈Çne dane (fallback: to co mamy w karcie)
  let probe;
  try { probe = await fetchMonitorDetails(id); }
  catch { probe = { id, name: card.querySelector('div[style*="font-weight:700"]')?.textContent || '', url: card.querySelector('.hint')?.textContent || '' }; }

  const { el, close } = createModal({
    title: 'Edytuj sondƒô',
    contentHtml: renderEditFormHTML(probe)
  });

  const modalRoot = el.querySelector('.modal-body');
  initEditForm(modalRoot, { id, onDone: async () => { close(); await load(); }, onCancel: close });
  return;
}

      } catch (err){
        alert(err.message || 'Operacja nie powiod≈Ça siƒô.');
      }
    });

    // === START ===
    load();
  }
  // ====== DYNAMICZNE WIDOKI ======
  async function loadView(name){
    const content = document.getElementById("content");
    content.textContent = "Wczytywanie‚Ä¶";
    try {
      if (name === "wyloguj") { logoutUser(); return; }

      const res = await fetch(`/widoki/${name}.html`, { cache: "no-store" });
      if (!res.ok) throw new Error("Brak widoku");

      const html = await res.text();
      content.innerHTML = html;

      // pod≈ÇƒÖczanie logik do widok√≥w
      initDodajSonde(content); // ju≈º by≈Ço
      initMojeSondy(content);
      initStatystyki(content);
      initHistoria(content);  // ‚¨Ö NOWE

      // aktywny przycisk + hash
      document.querySelectorAll(".app-nav-btn")
        .forEach(b => b.dataset.active = (b.dataset.view === name));
      history.replaceState(null, "", `#view=${encodeURIComponent(name)}`);
    } catch (e) {
      console.error("B≈ÇƒÖd ≈Çadowania widoku:", e);
      content.innerHTML = `<div class="card"><p>Nie uda≈Ço siƒô wczytaƒá widoku <strong>${name}</strong>.</p></div>`;
    }
  }


  // ====== OBS≈ÅUGA KLIKNIƒòƒÜ W SIDEBAR ======
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-view]");
    if (!btn) return;
    const view = btn.getAttribute("data-view");
    loadView(view);
  });

  // ====== START: wczytaj widok z hash lub domy≈õlnie ‚Äûmoje-sondy‚Äù ======
  (function boot(){
    const fromHash = location.hash.match(/view=([^&]+)/)?.[1];
    loadView(fromHash || "moje-sondy");
  })();



  function fmtDateTimePL(iso){
    if(!iso) return "‚Äî";
    const d = new Date(iso);
    return d.toLocaleString("pl-PL");
  }
  function fmtDurationSec(sec){
    if(sec == null) return "‚Äî";
    const s = Number(sec);
    if(Number.isNaN(s)) return "‚Äî";
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const r = s % 60;
    if(h>0) return `${h}h ${m}m`;
    if(m>0) return `${m}m ${r}s`;
    return `${r}s`;
  }
  function authHeaders(){
    const jwt = localStorage.getItem("jwt");
    return jwt ? { "Authorization": `Bearer ${jwt}` } : {};
  }

  async function initStatystyki(root){
    const kpisEl = root.querySelector("#stKpis");
    if(!kpisEl) return;

    const btnRefresh = root.querySelector("#stRefresh");
    const btnStopAllScan = root.querySelector("#stStopAllScan");
    const btnStopAllPlugin = root.querySelector("#stStopAllPlugin");

    async function load(){
      kpisEl.innerHTML = "";
      const scanBody = root.querySelector("#stScanBody");
      const scanEmpty = root.querySelector("#stScanEmpty");
      const plugBody = root.querySelector("#stPluginBody");
      const plugEmpty = root.querySelector("#stPluginEmpty");
      if(scanBody) scanBody.innerHTML = "";
      if(plugBody) plugBody.innerHTML = "";
      if(scanEmpty) scanEmpty.style.display = "none";
      if(plugEmpty) plugEmpty.style.display = "none";

      const r = await fetch("/api/statystyki", { headers: authHeaders(), cache:"no-store" });
      if(!r.ok) throw new Error("Nie uda≈Ço siƒô pobraƒá statystyk.");
      const data = await r.json();

      const monitors = data.monitors_total ?? 0;
      const total = data.scan_tasks?.total ?? 0;
      const ok = data.scan_tasks?.by_status?.ok ?? 0;
      const err = data.scan_tasks?.by_status?.blad ?? 0;
      const inprog = data.scan_tasks?.in_progress_count ?? 0;
      const analyses = data.analyses?.total ?? 0;

      kpisEl.innerHTML = `
        <div class="kpi">
          <div class="kpi-title">Monitory</div>
          <div class="kpi-value">${monitors}</div>
          <div class="kpi-sub">≈ÅƒÖcznie Twoich sond</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Zadania skanu</div>
          <div class="kpi-value">${total}</div>
          <div class="kpi-sub">W trakcie: ${inprog}</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Analizy</div>
          <div class="kpi-value">${analyses}</div>
          <div class="kpi-sub">Zapisane w Mongo/PG</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">B≈Çƒôdy</div>
          <div class="kpi-value">${err}</div>
          <div class="kpi-sub">Pomy≈õlne: ${ok}</div>
        </div>
      `;

      // scan in progress
      const scanRows = data.scan_tasks?.in_progress ?? [];
      if(!scanRows.length){
        if(scanEmpty) scanEmpty.style.display = "block";
      } else if(scanBody){
        scanBody.innerHTML = scanRows.map(row => `
          <tr>
            <td class="mono">${row.id}</td>
            <td>${row.monitor_name ?? row.monitorName ?? row.monitor ?? "‚Äî"}</td>
            <td><span class="pill pill--warn">${row.status}</span></td>
            <td>${fmtDateTimePL(row.rozpoczecie_at || row.started_at || row.start)}</td>
            <td>${fmtDurationSec(row.duration_seconds ?? row.duration_sec ?? row.duration)}</td>
            <td>${fmtDateTimePL(row.zakonczenie_at || row.end)}</td>
            <td style="text-align:right">
              <button class="btn btn--danger btn--sm" data-stop-scan="${row.id}">Zatrzymaj</button>
            </td>
          </tr>
        `).join("");

        scanBody.querySelectorAll("[data-stop-scan]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-stop-scan");
            btn.disabled = true;
            try{
              const rr = await fetch(`/api/statystyki/zadania/${id}/stop`, { method:"POST", headers: { ...authHeaders(), "Content-Type":"application/json" }});
              if(!rr.ok) throw new Error();
              await load();
            }catch(e){
              alert("Nie uda≈Ço siƒô zatrzymaƒá zadania.");
              btn.disabled = false;
            }
          });
        });
      }

      // plugin in progress (may be empty)
      const plugRows = data.plugin_tasks?.in_progress ?? [];
      if(!plugRows.length){
        if(plugEmpty) plugEmpty.style.display = "block";
      } else if(plugBody){
        plugBody.innerHTML = plugRows.map(row => `
          <tr>
            <td class="mono">${row.id ?? row._id ?? "‚Äî"}</td>
            <td>${row.monitor_name ?? row.monitorName ?? row.monitorId ?? row.monitor_id ?? "‚Äî"}</td>
            <td><span class="pill pill--warn">${row.status ?? "‚Äî"}</span></td>
            <td>${fmtDateTimePL(row.startedAt || row.start || row.createdAt || row.utworzone_at)}</td>
            <td>${fmtDurationSec(row.duration_seconds ?? row.duration_sec ?? row.duration)}</td>
            <td style="text-align:right">
              <button class="btn btn--danger btn--sm" data-stop-plugin="${row.id ?? row._id ?? ""}">Zatrzymaj</button>
            </td>
          </tr>
        `).join("");

        plugBody.querySelectorAll("[data-stop-plugin]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-stop-plugin");
            if(!id) return;
            btn.disabled = true;
            try{
              const rr = await fetch(`/api/statystyki/plugin-tasks/${id}/stop`, { method:"POST", headers: { ...authHeaders(), "Content-Type":"application/json" }});
              if(!rr.ok) throw new Error();
              await load();
            }catch(e){
              alert("Nie uda≈Ço siƒô zatrzymaƒá plugin taska.");
              btn.disabled = false;
            }
          });
        });
      }
    }

    btnRefresh?.addEventListener("click", load);
    btnStopAllScan?.addEventListener("click", async ()=>{
      if(!confirm("Zatrzymaƒá wszystkie zadania skanu w trakcie?")) return;
      await fetch(`/api/statystyki/zadania/stop-all`, { method:"POST", headers: { ...authHeaders(), "Content-Type":"application/json" }});
      await load();
    });
    btnStopAllPlugin?.addEventListener("click", async ()=>{
      if(!confirm("Zatrzymaƒá wszystkie plugin taski w trakcie?")) return;
      await fetch(`/api/statystyki/plugin-tasks/stop-all`, { method:"POST", headers: { ...authHeaders(), "Content-Type":"application/json" }});
      await load();
    });

    // initial
    load().catch(e=>{
      console.error(e);
      kpisEl.innerHTML = `<div class="hint">B≈ÇƒÖd: Nie uda≈Ço siƒô pobraƒá statystyk.</div>`;
      const scanEmpty = root.querySelector("#stScanEmpty");
      const plugEmpty = root.querySelector("#stPluginEmpty");
      if(scanEmpty) scanEmpty.style.display = "block";
      if(plugEmpty) plugEmpty.style.display = "block";
    });
  }

async function initHistoria(root){
  const bodyEl = root.querySelector("#histBody");
  if(!bodyEl) return;

  const qEl = root.querySelector("#histQ");
  const statusEl = root.querySelector("#histStatus");
  const limitEl = root.querySelector("#histLimit");
  const fromEl = root.querySelector("#histFrom");
  const toEl = root.querySelector("#histTo");
  const refreshBtn = root.querySelector("#histRefresh");
  const emptyEl = root.querySelector("#histEmpty");
  const pageEl = root.querySelector("#histPageLabel");
  const prevBtn = root.querySelector("#histPrev");
  const nextBtn = root.querySelector("#histNext");

  // ‚úÖ Modal z historia.html
  const backdrop = root.querySelector("#histModalBackdrop");
  const modalCloseX = root.querySelector("#histModalClose");
  const modalCloseBtn = root.querySelector("#histCloseBtn");
  const modalTitle = root.querySelector("#histModalTitle");

  const metaEl = root.querySelector("#histMeta");
  const migawkaEl = root.querySelector("#histMigawka");
  const analizaEl = root.querySelector("#histAnaliza");
  const logEl = root.querySelector("#histLog");
  const downloadBtn = root.querySelector("#histDownload");

  // Tabs (meta/migawka/analiza/log)
  const tabBtns = Array.from(root.querySelectorAll("[data-hist-tab]"));
  const panes = Array.from(root.querySelectorAll("[data-hist-pane]"));

  let page = 1;
  let total = 0;
  let pageSize = 20;

  // tekst do pobrania (Pobierz)
  let currentDownloadText = "";
  let currentDownloadFileName = "szczegoly.txt";

  function setActiveTab(name){
    tabBtns.forEach(b => b.classList.toggle("tab--active", b.dataset.histTab === name));
    panes.forEach(p => p.style.display = (p.dataset.histPane === name ? "" : "none"));
  }

  function openModal(){
    if(!backdrop) return;
    backdrop.style.display = "grid";
    document.body.style.overflow = "hidden";
    setActiveTab("meta");
  }

  function closeModal(){
    if(!backdrop) return;
    backdrop.style.display = "none";
    document.body.style.overflow = "";
  }

  modalCloseX?.addEventListener("click", closeModal);
  modalCloseBtn?.addEventListener("click", closeModal);
  backdrop?.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(); });

  tabBtns.forEach(btn=>{
    btn.addEventListener("click", ()=> setActiveTab(btn.dataset.histTab));
  });

  downloadBtn?.addEventListener("click", ()=>{
    const blob = new Blob([currentDownloadText || ""], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = currentDownloadFileName || "szczegoly.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  function qs(){
    const params = new URLSearchParams();
    const q = (qEl?.value || "").trim();
    const st = statusEl?.value || "";
    const lim = parseInt(limitEl?.value || "20", 10);
    const from = (fromEl?.value || "").trim();
    const to = (toEl?.value || "").trim();

    pageSize = Number.isFinite(lim) ? lim : 20;

    if(q) params.set("q", q);
    if(st) params.set("status", st);
    if(from) params.set("from", from);
    if(to) params.set("to", to);
    params.set("page", String(page));
    params.set("limit", String(pageSize));
    return params.toString();
  }

  function safeJson(obj){
    try { return JSON.stringify(obj, null, 2); }
    catch { return String(obj); }
  }

  function computeDurationSeconds(it){
    if(it?.duration_seconds != null) return Number(it.duration_seconds);
    const s = it?.rozpoczecie_at ? new Date(it.rozpoczecie_at).getTime() : null;
    const e = it?.zakonczenie_at ? new Date(it.zakonczenie_at).getTime() : null;
    if(!s || !e) return null;
    return Math.max(0, Math.floor((e - s) / 1000));
  }

  async function load(){
    bodyEl.innerHTML = "";
    emptyEl.style.display = "none";
    pageEl.textContent = "";

    const r = await fetch(`/api/historia?${qs()}`, { headers: authHeaders(), cache:"no-store" });
    if(!r.ok) throw new Error("Nie uda≈Ço siƒô pobraƒá historii.");

    const data = await r.json();
    const items = data.items || [];
    total = data.total || 0;

    if(!items.length){
      emptyEl.style.display = "block";
    } else {
      bodyEl.innerHTML = items.map(it=>{
        const st = it.status || "‚Äî";
        const pillClass =
          st === "ok" ? "pill--ok"
          : (st === "blad" ? "pill--blad"
          : (st === "anulowane" ? "pill--anulowane" : ""));

        const dur = computeDurationSeconds(it);

        return `
          <tr>
            <td class="mono">${it.id}</td>
            <td>${it.monitor_name || "‚Äî"}</td>
            <td><span class="pill ${pillClass}">${st}</span></td>
            <td>${fmtDateTimePL(it.rozpoczecie_at)}</td>
            <td>${fmtDateTimePL(it.zakonczenie_at)}</td>
            <td>${fmtDurationSec(dur)}</td>
            <td style="text-align:right">
              <button class="btn btn--primary btn--sm" data-hist-details="${it.id}">Szczeg√≥≈Çy</button>
            </td>
          </tr>
        `;
      }).join("");

      bodyEl.querySelectorAll("[data-hist-details]").forEach(btn=>{
        btn.addEventListener("click", ()=>showDetails(btn.getAttribute("data-hist-details")));
      });
    }

    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    pageEl.textContent = `Strona ${page} / ${totalPages}`;
    prevBtn.disabled = page <= 1;
    nextBtn.disabled = page >= totalPages;
  }

  async function showDetails(id){
    openModal();

    if(modalTitle) modalTitle.textContent = `Szczeg√≥≈Çy wykonania: ${id}`;
    if(metaEl) metaEl.textContent = "≈Åadowanie‚Ä¶";
    if(migawkaEl) migawkaEl.textContent = "≈Åadowanie‚Ä¶";
    if(analizaEl) analizaEl.textContent = "≈Åadowanie‚Ä¶";
    if(logEl) logEl.textContent = "≈Åadowanie‚Ä¶";

    const headers = authHeaders();

    // Pobieramy wszystko r√≥wnolegle, a potem sk≈Çadamy "log tekstowy" z Mongo/PG
    const [metaRes, snapRes, analizaRes] = await Promise.allSettled([
      fetch(`/api/historia/${id}`, { headers, cache:"no-store" }),
      fetch(`/api/historia/${id}/migawka`, { headers, cache:"no-store" }),
      fetch(`/api/historia/${id}/analiza`, { headers, cache:"no-store" }),
    ]);

    let meta = null;
    let migawka = null;
    let analiza = null;

    // meta
    try{
      if(metaRes.status === "fulfilled" && metaRes.value.ok){
        meta = await metaRes.value.json();
        if(metaEl){
          metaEl.innerHTML = `
            <div class="hint">
              <div><strong>Monitor:</strong> ${meta.monitor_name || "‚Äî"}</div>
              <div><strong>Status:</strong> ${meta.status || "‚Äî"}</div>
              <div><strong>Start:</strong> ${fmtDateTimePL(meta.rozpoczecie_at)}</div>
              <div><strong>Koniec:</strong> ${fmtDateTimePL(meta.zakonczenie_at)}</div>
              <div><strong>ID zadania:</strong> <span class="mono">${meta.id || id}</span></div>
              <div><strong>Snapshot ID:</strong> <span class="mono">${meta.snapshot_mongo_id || "‚Äî"}</span></div>
              <div><strong>Analiza ID:</strong> <span class="mono">${meta.analiza_mongo_id || "‚Äî"}</span></div>
            </div>
          `;
        }
      } else {
        if(metaEl) metaEl.textContent = "Nie uda≈Ço siƒô pobraƒá metadanych.";
      }
    }catch{
      if(metaEl) metaEl.textContent = "Nie uda≈Ço siƒô pobraƒá metadanych.";
    }

    // migawka
    try{
      if(snapRes.status === "fulfilled"){
        const r = snapRes.value;
        if(r.status === 404){
          migawka = null;
          if(migawkaEl) migawkaEl.textContent = "Brak migawki dla tego wykonania.";
        } else if(r.ok){
          migawka = await r.json();
          if(migawkaEl) migawkaEl.textContent = migawka?.tekst || migawka?.text || safeJson(migawka);
        } else {
          if(migawkaEl) migawkaEl.textContent = "Nie uda≈Ço siƒô pobraƒá migawki.";
        }
      } else {
        if(migawkaEl) migawkaEl.textContent = "Nie uda≈Ço siƒô pobraƒá migawki.";
      }
    }catch{
      if(migawkaEl) migawkaEl.textContent = "Nie uda≈Ço siƒô pobraƒá migawki.";
    }

    // analiza
    try{
      if(analizaRes.status === "fulfilled"){
        const r = analizaRes.value;
        if(r.status === 404){
          analiza = null;
          if(analizaEl) analizaEl.textContent = "Brak analizy dla tego wykonania.";
        } else if(r.ok){
          analiza = await r.json();
          if(analizaEl){
            if(analiza?.podsumowanie || analiza?.summary){
              analizaEl.textContent = analiza.podsumowanie || analiza.summary;
            } else {
              analizaEl.textContent = safeJson(analiza);
            }
          }
        } else {
          if(analizaEl) analizaEl.textContent = "Nie uda≈Ço siƒô pobraƒá analizy.";
        }
      } else {
        if(analizaEl) analizaEl.textContent = "Nie uda≈Ço siƒô pobraƒá analizy.";
      }
    }catch{
      if(analizaEl) analizaEl.textContent = "Nie uda≈Ço siƒô pobraƒá analizy.";
    }

    // ‚úÖ Zamiast endpointu /log robimy "log tekstowy" z danych
    const logDump = {
      meta,
      migawka,
      analiza,
    };

    currentDownloadText =
`TRACKLY ‚Äî SZCZEG√ì≈ÅY WYKONANIA
ID: ${id}

=== META (PG) ===
${safeJson(meta)}

=== MIGAWKA (Mongo) ===
${safeJson(migawka)}

=== ANALIZA / OCENA (Mongo) ===
${safeJson(analiza)}
`;

    currentDownloadFileName = `trackly_${id}.txt`;

    if(logEl) logEl.textContent = currentDownloadText || "(pusty)";
  }

  refreshBtn?.addEventListener("click", ()=>{ page = 1; load().catch(console.error); });

  [qEl, statusEl, limitEl, fromEl, toEl].forEach(el=>{
    el?.addEventListener("change", ()=>{ page = 1; load().catch(console.error); });
  });

  qEl?.addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){ page = 1; load().catch(console.error); }
  });

  prevBtn?.addEventListener("click", ()=>{
    if(page > 1){ page--; load().catch(console.error); }
  });

  nextBtn?.addEventListener("click", ()=>{
    page++;
    load().catch(console.error);
  });

  load().catch(e=>{
    console.error(e);
    if(emptyEl){
      emptyEl.style.display = "block";
      emptyEl.textContent = "B≈ÇƒÖd: Nie uda≈Ço siƒô pobraƒá historii.";
    }
  });
}


</script>
</html>


